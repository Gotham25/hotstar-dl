package tests

import (
	"reflect"
	"testing"

	"github.com/Gotham25/hotstar-dl/utils"
)

func TestGetMasterPlaybackURL_ValidURLs(t *testing.T) {
	playbackURIContent := `{"message":"Playback URL's fetched successfully","additionalInfo":{},"data":{"contentId":"1100036989","requestedConfig":"encryption:plain;ladder:phone,tv;package:hls,dash","playBackSets":[{"tagsCombination":"container:ts;encryption:plain;ladder:phone;package:hls","playbackUrl":"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/f6bddd5a60243822ae594497fa119c2c/master.m3u8?ladder=phone&hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/f6bddd5a60243822ae594497fa119c2c/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=f575dbcc6f1c2201ddc74d55aa4932e3f37ef06ac5d21f1eff9ef915a581a4e0","playbackCDNType":"INTERNAL","tokenAlgorithm":"AKAMAI-HMAC"},{"tagsCombination":"container:ts;encryption:plain;ladder:tv;package:hls","playbackUrl":"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/c0bb9c9838b7b72fe4e427431474f176/master.m3u8?hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/c0bb9c9838b7b72fe4e427431474f176/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=e2420d3d6593963ddaf3cff03beb340df677b7736dddeee72df2c3b0a83deb3f","playbackCDNType":"INTERNAL","tokenAlgorithm":"AKAMAI-HMAC"},{"tagsCombination":"encryption:plain;ladder:phone;package:dash","playbackUrl":"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/0fae2e1090372387d08d669469a3cbe3/master.mpd?ladder=phone&hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/0fae2e1090372387d08d669469a3cbe3/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=895ee9adfc261afdd6547d0dc5dda63e44e782614f1e745dd991f83d228151f0","playbackCDNType":"INTERNAL","tokenAlgorithm":"AKAMAI-HMAC"},{"tagsCombination":"encryption:plain;ladder:tv;package:dash","playbackUrl":"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/86b7499709f9c0c5cc211a3582aace0a/master.mpd?hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/86b7499709f9c0c5cc211a3582aace0a/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=1300555c99b7de373431b49aa27c7824801ceba298479d7c50d3ed082aa9a8f0","playbackCDNType":"INTERNAL","tokenAlgorithm":"AKAMAI-HMAC"},{"tagsCombination":"encryption:plain;package:dash","playbackUrl":"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/0fae2e1090372387d08d669469a3cbe3/master.mpd?hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/0fae2e1090372387d08d669469a3cbe3/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=895ee9adfc261afdd6547d0dc5dda63e44e782614f1e745dd991f83d228151f0","playbackCDNType":"INTERNAL","tokenAlgorithm":"AKAMAI-HMAC"},{"tagsCombination":"encryption:plain;package:hls","playbackUrl":"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/f6bddd5a60243822ae594497fa119c2c/master.m3u8?hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/f6bddd5a60243822ae594497fa119c2c/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=f575dbcc6f1c2201ddc74d55aa4932e3f37ef06ac5d21f1eff9ef915a581a4e0","playbackCDNType":"INTERNAL","tokenAlgorithm":"AKAMAI-HMAC"},{"tagsCombination":"container:fmp4;encryption:plain;ladder:phone;package:hls","playbackUrl":"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/140c12f9bb12def7c5d94e8bc62dad1f/master.m3u8?hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/140c12f9bb12def7c5d94e8bc62dad1f/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=f5b40779d9a26245d95582e47680f8bd2d82fbe55f3dbe061b2b57eca82ee80e","playbackCDNType":"INTERNAL","tokenAlgorithm":"AKAMAI-HMAC"},{"tagsCombination":"container:fmp4;encryption:plain;ladder:tv;package:hls","playbackUrl":"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/bcfbb6537f9a827b18292f87d193d8d5/master.m3u8?hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/bcfbb6537f9a827b18292f87d193d8d5/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=798213fe13e4810bf2a785af6c3dcefe1df3c241a69306b8c32837f7ad19b438","playbackCDNType":"INTERNAL","tokenAlgorithm":"AKAMAI-HMAC"}],"match":false,"drmClass":"BEST_EFFORT","downloadDrmClass":"BEST_EFFORT","isInternalPlayback":true}}`
	expectedMasterPlaybackURLs := []string{
		"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/f6bddd5a60243822ae594497fa119c2c/master.m3u8?ladder=phone&hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/f6bddd5a60243822ae594497fa119c2c/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=f575dbcc6f1c2201ddc74d55aa4932e3f37ef06ac5d21f1eff9ef915a581a4e0",
		"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/c0bb9c9838b7b72fe4e427431474f176/master.m3u8?hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/c0bb9c9838b7b72fe4e427431474f176/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=e2420d3d6593963ddaf3cff03beb340df677b7736dddeee72df2c3b0a83deb3f",
		"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/0fae2e1090372387d08d669469a3cbe3/master.mpd?ladder=phone&hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/0fae2e1090372387d08d669469a3cbe3/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=895ee9adfc261afdd6547d0dc5dda63e44e782614f1e745dd991f83d228151f0",
		"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/86b7499709f9c0c5cc211a3582aace0a/master.mpd?hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/86b7499709f9c0c5cc211a3582aace0a/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=1300555c99b7de373431b49aa27c7824801ceba298479d7c50d3ed082aa9a8f0",
		"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/0fae2e1090372387d08d669469a3cbe3/master.mpd?hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/0fae2e1090372387d08d669469a3cbe3/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=895ee9adfc261afdd6547d0dc5dda63e44e782614f1e745dd991f83d228151f0",
		"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/f6bddd5a60243822ae594497fa119c2c/master.m3u8?hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/f6bddd5a60243822ae594497fa119c2c/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=f575dbcc6f1c2201ddc74d55aa4932e3f37ef06ac5d21f1eff9ef915a581a4e0",
		"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/140c12f9bb12def7c5d94e8bc62dad1f/master.m3u8?hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/140c12f9bb12def7c5d94e8bc62dad1f/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=f5b40779d9a26245d95582e47680f8bd2d82fbe55f3dbe061b2b57eca82ee80e",
		"https://hses4.hotstar.com/videos/hotstarint/1260007199/1100036989/1584968543771/bcfbb6537f9a827b18292f87d193d8d5/master.m3u8?hdnea=st=1592120257~exp=1592120857~acl=/videos/hotstarint/1260007199/1100036989/1584968543771/bcfbb6537f9a827b18292f87d193d8d5/*~data=ip=070887a68d36212a105db056e290f7fec700d0ff1ce35cfc4d39fcc4-userid=350dc912fd2c1607badc207391e45d4ac52f88e0313dd1e7cedf5f994fbfa2cb~hmac=798213fe13e4810bf2a785af6c3dcefe1df3c241a69306b8c32837f7ad19b438",
	}

	actualMasterPlaybackURLs, err := utils.GetMasterPlaybackURLs([]byte(playbackURIContent))

	if err == nil && !reflect.DeepEqual(expectedMasterPlaybackURLs, actualMasterPlaybackURLs) {
		t.Error("Expected", expectedMasterPlaybackURLs, " but got", actualMasterPlaybackURLs)
	}
}

func TestGetMasterPlaybackURL_shouldPanic(t *testing.T) {
	playbackURIContent := `<html>
	<head>
	   <meta content="HTML Tidy for Java (vers. 27 Sep 2004), see www.w3.org" name="generator"/>
	   <title>Error</title>
	</head>
	<body>
	   An error occurred while processing your request.
	   <p>Reference #199.5e5f2c31.1592143978.71ee553</p>
	</body>
 </html>`

	// No need to check whether `recover()` is nil. Just turn off the panic.
	defer func() { recover() }()

	actualMasterPlaybackURLs, actualError := utils.GetMasterPlaybackURLs([]byte(playbackURIContent))

	t.Errorf("GetMasterPlaybackURLs did not panic. actualMasterPlaybackURLs: %v\tactualError: %v", actualMasterPlaybackURLs, actualError)
}
